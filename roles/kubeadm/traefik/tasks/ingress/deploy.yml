- name: Use certificates generated by cert-manager
  include_tasks: "{{ inventory_dir }}/roles/kubeadm/cert-manager/tasks/issue/tls.yml"
  when:
    - args_ingress.tls.enabled == true
    - args_ingress.tls.type == "cert-manager"

- name: Write ingress template to file
  template:
    src: "{{ inventory_dir }}/roles/kubeadm/traefik/templates/{{ item.src }}.j2"
    dest: "/server/tools/{{ args_role_service_name }}/{{ item.dest }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - { src: "ingress.yml", dest: "ingress-{{ args_ingress.name }}.yml" }

- name: Deploy ingress for external exposure
  kubernetes.core.k8s:
    state: present
    src: "/server/tools/{{ args_role_service_name }}/ingress-{{ args_ingress.name }}.yml"

- name: Add local hosts domain
  lineinfile:
    dest: /etc/hosts
    line: "{{ hostvars[groups['master'][0]].inventory_hostname }} {{ args_domain_name }}"
    backup: yes

- name: Check if service is healthy
  uri:
    method: "GET"
    url: "http{% if args_ingress.tls.enabled == true %}s{% endif %}://{{ args_domain_name }}"
    validate_certs: no
  register: _result
  until: _result.status == 200
  retries: "{{ args_retries | default(5) }}"
  delay: "{{ args_delay | default(30) }}"